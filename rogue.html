<canvas id=c width=800 height=600 />
<script>
M=Math;E=e=>document.getElementById(e);D=(x,y,w,h,c)=>{G.fillStyle=c;G.fillRect(x,y,w,h)};RI=(a, b)=>{a=M.ceil(a);b=M.floor(b);return M.floor(M.random()*(b-a))+a};P=(x,y)=>y*mw+x
ml=20;mw=20;mh=15;pl=[mw/2,mh-1];cw="#544";cd="#B80";m=[100];m[P(pl[0],pl[1])]="dwww"

GM=(n,l)=>{
if(l==0)return 1;
if(l==1){m[P(n[0],n[1])]=GR(n,"w");return 1}
m[P(n[0],n[1])]=GR(n,"do");
pd=PBR(n);
ret=0;
for(i=0;i<pd.length;i++) {ret=GM(pd[i],l-1);if(ret) break}
return ret;
}

GA=_=>{
n=1;
while(n){
n=0;
for(j=0;j<mh;j++)
for(i=0;i<mw;i++){
p=[i,j];           
if(HR(p))
{
pd=PBR([i,j]);
for(k=0;k<pd.length;k++){
n=1;
m[P(pd[k][0],pd[k][1])]=GR(pd[k],"dowww");
}}}}}


PBR=p=>{
rm=m[p[1]*mw+p[0]];pd=[];
if((rm[0]=='d'||rm[0]=='o')&&!HR([p[0],p[1]-1]))pd.push([p[0],p[1]-1])
if((rm[1]=='d'||rm[1]=='o')&&!HR([p[0]-1,p[1]]))pd.push([p[0]-1,p[1]])
if((rm[2]=='d'||rm[2]=='o')&&!HR([p[0],p[1]+1]))pd.push([p[0],p[1]+1])
if((rm[3]=='d'||rm[3]=='o')&&!HR([p[0]+1,p[1]]))pd.push([p[0]+1,p[1]])
return pd.sort(e=>0.5-M.random());
}

HR=p=>{
if(p[0]>=mw||p[1]>=mh||p[0]<0||p[1]<0) return 1;
return (m[(p[1])*mw+p[0]]!=undefined)
}

PT=(p,c)=>{
if(p[1]<=0)return "w";
room=m[P(p[0],p[1]-1)]
if(room==undefined)return c[RI(0,c.length)];
return room[2];
}
PL=(p,c)=>{
if(p[0]<=0)return "w";
room=m[P(p[0]-1,p[1])];
if(room==undefined)return c[RI(0,c.length)];
return room[3];
}
PB=(p,c)=>{
if(p[1]>=(mh-1))return "w";
room=m[P(p[0],p[1]+1)];
if(room==undefined)return c[RI(0,c.length)];
return room[0];
}
PR=(p,c)=>{
if(p[0]>=(mw-1)) return "w";
room = m[P(p[0]+1,p[1])];
if(room==undefined)return c[RI(0,c.length)];
return room[1];
}

GR=(p,c)=>{
return PT(p,c)+PL(p,c)+PB(p,c)+PR(p,c)
}

R=e=>{
for(h=0;h<mh;h++)for(w=0;w<mw;w++){
if(m[P(w,h)]==undefined)continue;
if(m[P(w,h)][0]=="w") D(w*36,h*36,36,3,cw)
if(m[P(w,h)][0]=="d") D(w*36,h*36,12,3,cw),D(w*36+12,h*36,12,3,cd),D(w*36+24,h*36, 12,3,cw)
if(m[P(w,h)][0]=="o") D(w*36,h*36,3,3,cw),D(w*36+33,h*36,3,3,cw)
if(m[P(w,h)][1]=="w") D(w*36,h*36,3,36,cw)
if(m[P(w,h)][1]=="d") D(w*36,h*36,3,12,cw),D(w*36,h*36+12,3,12,cd),D(w*36,h*36+24,3,12,cw)
if(m[P(w,h)][1]=="o") D(w*36,h*36,3,3,cw),D(w*36,h*36+33,3,3,cw)
if(m[P(w,h)][2]=="w") D(w*36,h*36+33,36,3,cw)
if(m[P(w,h)][2]=="d") D(w*36,h*36+33,12,3,cw),D(w*36+12,h*36+33,12,3,cd),D(w*36+24,h*36+33,12,3,cw)
if(m[P(w,h)][2]=="o") D(w*36,h*36+33,3,3,cw),D(w*36+33,h*36+33,3,3,cw)
if(m[P(w,h)][3]=="w") D(w*36+33,h*36,3,36,cw);
if(m[P(w,h)][3]=="d") D(w*36+33,h*36,3,12,cw),D(w*36+33,h*36+12,3,12,cd),D(w*36+33,h*36+24,3,12,cw)
if(m[P(w,h)][3]=="o") D(w*36+33,h*36,3,3,cw),D(w*36+33,h*36+33,3,3,cw)       
}
requestAnimationFrame(R);
}
KD=e=>{}
GM([pl[0],pl[1]-1],ml);GA();
C=E("c");O=E("o");G=C.getContext("2d");C.tabIndex=1;C.addEventListener("keydown",KD);R(0)
</script>