<canvas id=c width=800 height=600 />
<script>
M=Math;E=e=>document.getElementById(e);D=(x,y,w,h,c)=>{G.fillStyle=c;G.fillRect(x,y,w,h)};RI=(a,b)=>M.floor(M.random()*(M.floor(b)-M.ceil(a)))+M.ceil(a);P=(x,y)=>y*mw+x;Q=p=>p[1]*mw+p[0];F=(p,a,b)=>[p[0]+a,p[1]+b]
ml=15;mw=20;mh=15;pl=[mw/2,mh-1];cw="#544";cd="#B80";cp="#F0F";cs="#0FF";cx="#0F0";m=[100];m[Q(pl)]="dwwws";w='w';d='d';o='o';S=36;

KD=e=>{

}

GM=(n,l)=>{if(l==0)return 1;if(l==1){m[Q(n)]=GR(n,w)+"x";return 1}m[Q(n)]=GR(n,"do");pd=BR(n);r=0;for(i=0;i<pd.length;i++){r=GM(pd[i],l-1);if(r)break}return r;}
GA=_=>{n=1;while(n){n=0;for(j=0;j<mh;j++)for(i=0;i<mw;i++){p=[i,j];if(HR(p)){pd=BR([i,j]);for(k=0;k<pd.length;k++){n=1;m[Q(pd[k])]=GR(pd[k],"dowww")}}}}}
BR=p=>{
rm=m[Q(p)];pd=[];
if((rm[0]==d||rm[0]==o)&&!HR(F(p,0,-1)))pd.push(F(p,0,-1))
if((rm[1]==d||rm[1]==o)&&!HR(F(p,-1,0)))pd.push(F(p,-1,0))
if((rm[2]==d||rm[2]==o)&&!HR(F(p,0,1)))pd.push(F(p,0,1))
if((rm[3]==d||rm[3]==o)&&!HR(F(p,1,0)))pd.push(F(p,1,0))
return pd.sort(e=>0.5-M.random())
}
HR=p=>(p[0]>=mw||p[1]>=mh||p[0]<0||p[1]<0)||m[Q(p)];GR=(p,c)=>(p[1]<=0?w:m[Q(F(p,0,-1))]?m[Q(F(p,0,-1))][2]:c[RI(0,c.length)])+(p[0]<=0?w:m[Q(F(p,-1,0))]?m[Q(F(p,-1,0))][3]:c[RI(0,c.length)])+(p[1]>=(mh-1)?w:m[Q(F(p,0,1))]?m[Q(F(p,0,1))][0]:c[RI(0,c.length)])+(p[0]>=(mw-1)?w:m[Q(F(p,1,0))]?m[Q(F(p,1,0))][1]:c[RI(0,c.length)])
R=_=>{
for(j=0;j<mh;j++)for(i=0;i<mw;i++){
r=m[Q([i,j])];
x=i*S;y=j*S
if(!r)continue;
if(r[0]==w)D(x,y,S,3,cw)
if(r[0]==d)D(x,y,12,3,cw),D(x+12,y,12,3,cd),D(x+24,y,12,3,cw)
if(r[0]==o)D(x,y,3,3,cw),D(x+33,y,3,3,cw)
if(r[1]==w)D(x,y,3,S,cw)
if(r[1]==d)D(x,y,3,12,cw),D(x,y+12,3,12,cd),D(x,y+24,3,12,cw)
if(r[1]==o)D(x,y,3,3,cw),D(x,y+33,3,3,cw)
if(r[2]==w)D(x,y+33,S,3,cw)
if(r[2]==d)D(x,y+33,12,3,cw),D(x+12,y+33,12,3,cd),D(x+24,y+33,12,3,cw)
if(r[2]==o)D(x,y+33,3,3,cw),D(x+33,y+33,3,3,cw)
if(r[3]==w)D(x+33,y,3,S,cw)
if(r[3]==d)D(x+33,y,3,12,cw),D(x+33,y+12,3,12,cd),D(x+33,y+24,3,12,cw)
if(r[3]==o)D(x+33,y,3,3,cw),D(x+33,y+33,3,3,cw)
if(r[4]=="s")D(x+15,y+15,6,6,cs)
if(r[4]=="x")D(x+15,y+15,6,6,cx)
}
D(pl[0]*S+14,pl[1]*S+14,8,8,cp)
}

C=E("c");O=E("o");G=C.getContext("2d");C.tabIndex=1;C.addEventListener("keyup",KD);GM([pl[0],pl[1]-1],ml);GA();R(0)
</script>